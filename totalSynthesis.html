<!--
  This is the reactSearch reactions database graphical user interface for adding new reaction.
  Developed by reactSearch team developer @mawansui (Maxim Shevelev).
  Being actively maintained and used by the team.
  (c) reactSearch team, 2017, Kazan, Russia.
-->


<!DOCTYPE html>
   <html lang="en">
     <head>
       <title>Total Synthesis Addition</title>
       <meta name="viewport" content="width=device-width, initial-scale=1">
       <link href="https://bootswatch.com/lumen/bootstrap.min.css" rel="stylesheet">

       <script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
       <script type="text/javascript" src="bs/js/bootstrap.min.js"></script>
       <script type="text/javascript" src='js/jsoneditor.js'></script>
       <link rel="stylesheet" href="./minified/themes/default.min.css" type="text/css" media="all" />
       <script type="text/javascript" src="./minified/jquery.sceditor.bbcode.min.js"></script>

 </head>
 <body>

   <!-- Navigation -->
   <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
       <div class="container">
           <!-- Brand and toggle get grouped for better mobile display -->
           <div class="navbar-header">
               <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                   <span class="sr-only">Menu</span>
                   <span class="icon-bar"></span>
                   <span class="icon-bar"></span>
                   <span class="icon-bar"></span>
               </button>
               <a class="navbar-brand" href="./index.html">ReactSearch</a>
           </div>
           <!-- Collect the nav links, forms, and other content for toggling -->
           <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
               <ul class="nav navbar-nav">
                   <li>
                       <a href="#">About us</a>
                   </li>
                   <li>
                       <a href="./totalSynthesis.html">Add Total Synthesis</a>
                   </li>
                   <li>
                       <a href="./functionalGroup.html">Add Func Group Synthesis</a>
                   </li>
                   <li>
                       <a href="#">Add Reaction</a>
                   </li>
                   <li>
                       <a href="#">Contact us</a>
                   </li>
               </ul>
           </div>
           <!-- /.navbar-collapse -->
       </div>
       <!-- /.container -->
   </nav>

   <div class='container'>
       <div class='row'>
           <div class='span12 col-md-12 columns twelve large-12'>
             <br><br><br>
               <h2>ReactSearch Total Synthesis Addition GUI</h2>
               <p>The editor is generated from the JSON Schema with the help from <a href="https://github.com/jdorn/json-editor">json-editor</a> made by <a href="https://github.com/jdorn">@jdorn</a>.</p>
               <p>The helpful utilities on the right were developed and are actively maintained by <a href="https://github.com/mawansui">@mawansui</a> from the <a href="https://github.com/reactSearch">reactSearch team</a>.</p>

               <br>
               <div class="row">
                 <div class="col-md-8">
                   <div id='editor'></div>
                   <br>
                   <p><b>Type in the password to proceed:</b></p>
                   <br>

                   <input class="form-control" placeholder="Password" type="text" id="password"><br><br>
                   <button id="submit" class="btn btn-success" type="submit">Add reaction</button>
                   <br>
                   <br>
                   <p id="uploadStatus">Upload status</p>
                   <br><br><br>
                   <p>Resulting JSON (just for you to look at it, it will paste automatically now!).</p>
                   <textarea id='output' style='width: 100%; height: 300px; font-family: monospace;' class='form-control'></textarea>
                   <br><br>
                 </div>
                 <div class="col-md-4">
                 <form>
                   <div class="form-group">
                    <br><br><br><br><br><br><br><br>
                    <a href="https://marvinjs-demo.chemaxon.com/latest/demo.html" target="_blank"><button type="button" class="btn btn-success">Draw a molecule</button></a><br>To get it's InChIKey<br>(Opens in new tab; TODO: opening in modal)
                    <br><br><br>
                    <a href="http://imgh.us/" target="_blank"><button type="button" class="btn btn-danger">UpLoad Reaction Image</button></a><br>Paste your link and copy the resulting one
                    <br><br><br>
                     <label for="exampleInputEmail1">Get InChIKey for any compound by it's IUPAC or rational name</label>
                     <input type="text" class="form-control" id="exampleInputEmail1" placeholder="Use IUPAC or rational nomenclature">
                   </div>
                   <button type="button" class="btn btn-default" id="getINCHIKEY">Get InChIKey</button>
                   <br><br>


                     <label id="KEY">Result will be displayed here</label>


                     <img src="http://vignette3.wikia.nocookie.net/plants-vs-zombies-roleplay/images/6/60/Question_Mark.png/revision/latest?cb=20140425200212" alt="Compound image by CID" width="250px" height="250px" id="compoundImage">


                  </form>
                  <br><br><br><br>
                  <form>
                    <label for="publicationMetadata">Type in the publication metadata</label>
                    <input type="text" class="form-control" id="publicationMetadata" placeholder="Copy n paste it!">
                    <br>
                    <button type="button" class="btn btn-default" id="getDOI">Get DOI</button>
                    <br><br>
                    <label id="DOI">DOI will be displayed here</label>
                  </form>
               </div>
               </div>
           </div>
       </div>
   </div>

   <!-- Initializing the JSON form script -->
   <script>
    var editor = new JSONEditor(document.getElementById('editor'), {
      schema: {
          "title": "Add new reaction to the database",
          "type": "object",
          "properties": {

            "products": {
              "type": "array",
              "format": "table",
              "title": "Resulting products",
              "description": "Insert the InChIKeys of the final products (one at a time); this is used for the reaction searching and identifying!",
              "uniqueItems": true,
              "items": {
                "type": "string",
                "title": "product's InChIKey"
              },
              "options": {
                "disable_array_delete_last_row": true
              },
              "propertyOrder" : 1
            },

            "reactionImageLink": {
              "type": "string",
              "description": "Reaction overview image link (chemical equation image), preferably in PNG. SHOULD BE HOSTED ON AN HTTPS-ENCRYPTED SERVER! EXAMPLE: https://raw.github.com/mawansui/reactions/id0.png",
              "propertyOrder" : 2
            },

            "imageWidth": {
              "type": "integer",
              "description": "First number in 1024 x 680.",
              "propertyOrder" : 3
            },

            "imageHeight": {
              "type": "integer",
              "description": "Second number in 1024 x 680.",
              "propertyOrder" : 4
            },

            "conditions": {
              "type": "string",
              "description": "Conditions at which the reaction takes place. EXAMPLE: 20 deg C, 101.3 kPa",
              "propertyOrder" : 5
            },

            "catalysts": {
              "type": "string",
              "description": "What catalyses the reaction?",
              "format": "html",
              "options": {
                "wysiwyg": true
              },
              "propertyOrder" : 6
            },

            "procedure": {
              "type": "string",
              "format": "html",
              "options": {
                "wysiwyg": true
              },
              "propertyOrder" : 7
            },

            "sources": {
              "type": "array",
              "format": "table",
              "title": "Sources",
              "uniqueItems": true,
              "description": "Anything from books/articles to webpages.",
              "propertyOrder" : 8,
              "items": {
                "type": "object",
                "title": "Source",
                "properties": {
                  "fullBibliograficInfo": {
                   "type": "string"
                  },
                  "sourceImageLink": {
                    "type": "string"
                  },
                  "DOI": {
                   "type": "string"
                  }
                }
              },
              "options": {
                "disable_array_delete_last_row": true
              }
            },

            "keywords": {
              "type": "array",
              "format": "table",
              "title": "Keywords to search by",
              "description": "Type in the keywords by which users will be able to search for this reaction. Please make them lower-case!!! Example: decarboxylation, hydrogentaion, oxidation, ...",
              "uniqueItems": true,
              "propertyOrder" : 9,
              "items": {
                "type": "string",
                "title": "keyword"
              },
              "options": {
                "disable_array_delete_last_row": true
              }
            },

            "functionalGroups": {
              "type": "array",
              "format": "table",
              "title": "Functional groups to search by",
              "propertyOrder" : 10,
              "options": {
                "disable_array_delete_last_row": true
              },
              "description": "Choose the functional group present in the initial reagent and then choose to which it transforms as a result of the reaction you are describing.",
              "items": {
                "type": "object",
                "title": "funcGroup",
                "properties": {
                  "from": {
                    "type": "string",
                    "enum": [
                      "- Hydrocarbons -",
                      "Alkyl",
                      "Alkenyl",
                      "Alkynyl",
                      "Phenyl",
                      " ",
                      "- With halogen -",
                      "Halo",
                      "Fluoro",
                      "Chloro",
                      "Bromo",
                      "Iodo",
                      " ",
                      "- With oxygen -",
                      "Hydroxyl",
                      "Carbonyl",
                      "Aldehyde",
                      "Haloformyl",
                      "Carbonate ester",
                      "Carboxylate",
                      "Carboxyl",
                      "Ester",
                      "Methoxy",
                      "Hydroperoxy",
                      "Peroxy",
                      "Ether",
                      "Hemiacetal",
                      "Hemiketal",
                      "Acetal",
                      "Ketal",
                      "Orthoester",
                      "Methylenedioxy",
                      "Orthocarbonate ester",
                      " ",
                      "- With nitrogen -",
                      "Carboxamide",
                      "Primary amine",
                      "Secondary amine",
                      "Tertiary amine",
                      "4° ammonium ion",
                      "Primary ketimine",
                      "Secondary ketimine",
                      "Primary aldimine",
                      "Secondary aldimine",
                      "Imide",
                      "Azide",
                      "Azo (Diimide)",
                      "Cyanate",
                      "Isocyanate",
                      "Nitrate",
                      "Nitrile",
                      "Isonitrile",
                      "Nitrosooxy",
                      "Nitro",
                      "Nitroso",
                      "Oxime",
                      "Pyridyl",
                      " ",
                      "- With sulfur -",
                      "Sulfhydryl",
                      "Sulfide",
                      "Disulfide",
                      "Sulfinyl",
                      "Sulfonyl",
                      "Sulfino",
                      "Sulfo",
                      "Thiocyanate",
                      "Isothiocyanate",
                      "Carbonothioyl",
                      "Carbonothioyl",
                      " ",
                      "- With phosphorous -",
                      "Phosphino",
                      "Phosphono",
                      "Phosphate",
                      "Phosphate",
                      " ",
                      "- With boron -",
                      "Borono",
                      "Boronate",
                      "Borino",
                      "Borinate"
                    ]
                  },
                  "to": {
                    "type": "string",
                    "enum": [
                      "- Hydrocarbons -",
                      "Alkyl",
                      "Alkenyl",
                      "Alkynyl",
                      "Phenyl",
                      " ",
                      "- With halogen -",
                      "Halo",
                      "Fluoro",
                      "Chloro",
                      "Bromo",
                      "Iodo",
                      " ",
                      "- With oxygen -",
                      "Hydroxyl",
                      "Carbonyl",
                      "Aldehyde",
                      "Haloformyl",
                      "Carbonate ester",
                      "Carboxylate",
                      "Carboxyl",
                      "Ester",
                      "Methoxy",
                      "Hydroperoxy",
                      "Peroxy",
                      "Ether",
                      "Hemiacetal",
                      "Hemiketal",
                      "Acetal",
                      "Ketal",
                      "Orthoester",
                      "Methylenedioxy",
                      "Orthocarbonate ester",
                      " ",
                      "- With nitrogen -",
                      "Carboxamide",
                      "Primary amine",
                      "Secondary amine",
                      "Tertiary amine",
                      "4° ammonium ion",
                      "Primary ketimine",
                      "Secondary ketimine",
                      "Primary aldimine",
                      "Secondary aldimine",
                      "Imide",
                      "Azide",
                      "Azo (Diimide)",
                      "Cyanate",
                      "Isocyanate",
                      "Nitrate",
                      "Nitrile",
                      "Isonitrile",
                      "Nitrosooxy",
                      "Nitro",
                      "Nitroso",
                      "Oxime",
                      "Pyridyl",
                      " ",
                      "- With sulfur -",
                      "Sulfhydryl",
                      "Sulfide",
                      "Disulfide",
                      "Sulfinyl",
                      "Sulfonyl",
                      "Sulfino",
                      "Sulfo",
                      "Thiocyanate",
                      "Isothiocyanate",
                      "Carbonothioyl",
                      "Carbonothioyl",
                      " ",
                      "- With phosphorous -",
                      "Phosphino",
                      "Phosphono",
                      "Phosphate",
                      "Phosphate",
                      " ",
                      "- With boron -",
                      "Borono",
                      "Boronate",
                      "Borino",
                      "Borinate"
                    ]
                  }
                }
              }
            },

            "uploadedBy": {
              "type": "string",
              "description": "Type your name/nickname here. It will be useful later.",
              "propertyOrder" : 11
            }

          }
        },
        theme: 'bootstrap3',
        disable_collapse: 'true',
        disable_edit_json: 'true',
        disable_properties: 'true',
        disable_array_reorder: 'true'
    });

    document.getElementById('submit').addEventListener('click', function() {
      // Development stuff: http://localhost:8080/api/savedata
      // Development stuff: https://reactsearchdb.herokuapp.com/api/getdata
      console.log(editor.getValue());
      var display = document.getElementById('output');
      var finaljson = editor.getValue(); // I need this!
      console.log("** * * ** * * *");
      console.log(finaljson);
      var password = document.getElementById('password').value;
      var statusLabel = document.getElementById('uploadStatus');
      // statusLabel.innerText = password;
      display.value = JSON.stringify(finaljson);

      if (password == "osresearch17") {

        $.ajax({
          type: 'POST',
          url: 'https://reactsearchdb.herokuapp.com/api/savedata',
          data: finaljson,
          success: function(data) { statusLabel.innerHTML = "Upload successful! Feel free to <b>reload the page</b> and work on the next reaction, if you prefer.";},
          error: function (jqXHR, exception) {
              var msg = '';
              if (jqXHR.status === 0) {
                  msg = 'Upload unsuccessful! There may be a problem with the database (ERROR 503), please contact me at t.me/mawansui as fast as possible.';
              } else if (jqXHR.status == 200) {
                msg = 'Upload successful! Feel free to reload the page and work on the next reaction, if you prefer.';
              } else if (jqXHR.status == 404) {
                  msg = 'Upload unsuccessful! Code: Requested page not found. [404]. Please contact me at t.me/mawansui as fast as possible.';
              } else if (jqXHR.status == 500) {
                  msg = 'Upload unsuccessful! Code: Internal Server Error [500]. Please contact me at t.me/mawansui as fast as possible.';
              } else if (exception === 'timeout') {
                  msg = 'Upload unsuccessful! Code: Time out error. Please contact me at t.me/mawansui as fast as possible.';
              } else if (exception === 'abort') {
                  msg = 'Upload unsuccessful! Code: Ajax request aborted. Please contact me at t.me/mawansui as fast as possible.';
              } else {
                  msg = 'Upload unsuccessful! And we don\'t even know, why :C Here is the error code:\n' + jqXHR.responseText + " Status: " + jqXHR.status + "\nHow did you like that? Please contact me at t.me/mawansui as fast as possible, and tell me the error code.";
                  console.log(jqXHR);
              }
              statusLabel.innerText = msg;
          },
          crossDomain: true,
          dataType: 'application/json'
        });

        // $.post("https://reactsearchdb.herokuapp.com/api/savedata", finaljson, function(){
        //   console.log('Success? I guess?');
        // });
        statusLabel.innerText = "Upload successful! Feel free to reload the page and work on the next reaction, if you prefer."
      } else {
        statusLabel.innerHTML = "Sorry, you\'ve typed in <b>an incorrect password</b>. Upload unsuccessful."
      }
    });

    var user_input = document.getElementById('exampleInputEmail1').value;


    function searchByCompoundName() {
      console.log("button pressed");
      var user_input = document.getElementById('exampleInputEmail1').value;
      console.log(user_input);

      var urlToParseForKey = "https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/"+user_input+"/property/InChIKey/JSON";
      console.log(urlToParseForKey);

      var finalKey;

      var getJSON = function(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open("get", url, true);
        xhr.responseType = "json";
        xhr.onload = function() {
          var status = xhr.status;
          if (status == 200) {
            callback(null, xhr.response);
          } else {
            callback(status);
          }
        };
        xhr.send();
    };

    getJSON(urlToParseForKey,
      function(err, data) {
        if (err != null) {
          finalKey = "Sorry, something went wrong! Probably, PubChem doesn't have a record on ";
          var keyOutput = document.getElementById('KEY');
          keyOutput.innerText = finalKey + user_input + " yet.";
          var noImage = "http://vignette3.wikia.nocookie.net/plants-vs-zombies-roleplay/images/6/60/Question_Mark.png/revision/latest?cb=20140425200212";
          document.getElementById('compoundImage').src = noImage;
        } else {
          console.log(data.PropertyTable.Properties[0].InChIKey);
          finalKey = data.PropertyTable.Properties[0].InChIKey;
          var keyOutput = document.getElementById('KEY');
          keyOutput.innerText = "Result for "+user_input+": "+finalKey;
          var imageFromPubChem = 'https://pubchem.ncbi.nlm.nih.gov/image/imagefly.cgi?cid='+data.PropertyTable.Properties[0].CID+'&width=250&height=250';
          document.getElementById('compoundImage').src = imageFromPubChem;

        }
      });
    }

    // Getting the PCID and image by the enter key
    document.getElementById('exampleInputEmail1').addEventListener('keypress', function(e){
      var key = e.which || e.keyCode;
      if (key === 13) {
        e.preventDefault();
        console.log('hello world');
        searchByCompoundName();
      }
      return;
    });


    // Getting the PCID and image by the button press

    document.getElementById('getINCHIKEY').addEventListener('click', function() {
      searchByCompoundName();
    });

    document.getElementById('getDOI').addEventListener('click', function() {
      document.getElementById('DOI').innerText = 'Searching for DOI...';
      console.log('DOI SEARCH HAPPENING');
      var metadataInput = document.getElementById('publicationMetadata').value;
      console.log(metadataInput);
      var parseDoiURL = 'http://api.crossref.org/works?query='+metadataInput;
      console.log('Parseing this: ' + parseDoiURL);
      $.get(parseDoiURL, function(response) {
        try {
          console.log(response.message.items[0].DOI);
          var crossrefResponse = response.message.items[0].DOI;
          document.getElementById('DOI').innerHTML = '<strong>Most likely,</strong> this source\'s DOI is ' + crossrefResponse;
        } catch (err) {
          console.log(err);
          document.getElementById('DOI').innerText = 'Sorry, couldn\'t find any DOI for this one.';
        }
      }).fail(function(r) {
        console.log(r.statusText);
        document.getElementById('DOI').innerText = 'A mistake occured! Please contact @mawansui in Telegram.';
      });
    });

   </script>

 </body>
</html>

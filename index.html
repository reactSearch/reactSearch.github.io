<!--
  This is the reactSearch reactions database graphical user interface for adding new reaction.
  Developed by reactSearch team developer @mawansui (Maxim Shevelev).
  Being actively maintained and used by the team.
  (c) reactSearch team, 2017, Kazan, Russia.
-->


<!DOCTYPE html>
   <html lang="en">
     <head>
       <title>reactSearch DB GUI</title>
       <meta name="viewport" content="width=device-width, initial-scale=1">
       <link href="bs/css/bootstrap.min.css" rel="stylesheet">
       <link href="bs/css/bootstrap-theme.min.css" rel="stylesheet">
       <script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
       <script type="text/javascript" src="bs/js/bootstrap.min.js"></script>
       <script type="text/javascript" src='js/jsoneditor.js'></script>
       <link rel="stylesheet" href="./minified/themes/default.min.css" type="text/css" media="all" />
       <script type="text/javascript" src="./minified/jquery.sceditor.bbcode.min.js"></script>

 </head>
 <body>
   <div class='container'>
       <div class='row'>
           <div class='span12 col-md-12 columns twelve large-12'>

               <h2>reactSearch Database GUI</h2>
               <p>The editor is generated from the JSON Schema with the help from <a href="https://github.com/jdorn/json-editor">json-editor</a> made by <a href="https://github.com/jdorn">@jdorn</a>.</p>
               <p>The PubChem parser on the right was made and is actively maintained by <a href="https://github.com/mawansui">@mawansui</a> from the <a href="https://github.com/reactSearch">reactSearch team</a>.</p>

               <br>
               <div class="row">
                 <div class="col-md-9">
                   <div id='editor'></div>
                   <br>
                   <p><b>Type in the password to proceed:</b></p>
                   <br>
                   <input type="text" id="password"><br><br>
                   <button id="submit" class="btn btn-success" type="submit">Add reaction</button>
                   <br>
                   <br>
                   <p id="uploadStatus">Upload status</p>
                   <br><br><br>
                   <p>Resulting JSON. <b>TODO: automatic pasting into the database</b></p>
                   <textarea id='output' style='width: 100%; height: 300px; font-family: monospace;' class='form-control'></textarea>
                   <br><br>
                 </div>
                 <div class="col-md-3">
                 <form>
                   <div class="form-group">
                    <br><br><br>
                     <label for="exampleInputEmail1">Get PubChem ID for any compound by it's IUPAC or rational name</label>
                     <input type="text" class="form-control" id="exampleInputEmail1" placeholder="Use IUPAC or rational nomenclature">
                   </div>
                   <button type="button" class="btn btn-default" id="getPCID">Get PubChem ID</button>
                   <br><br>


                     <label id="PCID">Result will be displayed here</label>


                     <img src="http://vignette3.wikia.nocookie.net/plants-vs-zombies-roleplay/images/6/60/Question_Mark.png/revision/latest?cb=20140425200212" alt="Compound image by CID" width="250px" height="250px" id="compoundImage">


                  </form>
                 <br>
               </div>
               </div>
           </div>
       </div>
   </div>

   <!-- Initializing the JSON form script -->
   <script>
    var editor = new JSONEditor(document.getElementById('editor'), {
      schema: {
          "title": "Add new reaction to the DB",
          "type": "object",
          "properties": {

            "products": {
              "type": "array",
              "format": "table",
              "title": "Resulting products",
              "description": "Insert the PubChem IDs of the final products (one at a time); this is used for the reaction searching and identifying!",
              "uniqueItems": true,
              "items": {
                "type": "integer",
                "title": "product's PubChem ID"
              },
              "default": [
                0
              ],
              "options": {
                "disable_array_delete_last_row": true
              }
            },

            "reactionImageLink": {
              "type": "string",
              "description": "Reaction overview image link (chemical equation image), preferably in PNG. SHOULD BE HOSTED ON AN HTTPS-ENCRYPTED SERVER! EXAMPLE: https://raw.github.com/mawansui/reactions/id0.png"
            },

            "imageWidth": {
              "type": "integer",
              "description": "First number in 1024 x 680."
            },

            "imageHeight": {
              "type": "integer",
              "description": "Second number in 1024 x 680."
            },

            "conditions": {
              "type": "string",
              "description": "Conditions at which the reaction takes place. EXAMPLE: 20 deg C, 101.3 kPa"
            },

            "catalysts": {
              "type": "string",
              "description": "What catalyses the reaction?",
              "format": "html",
              "options": {
                "wysiwyg": true
              }
            },

            "procedure": {
              "type": "string",
              "format": "html",
              "options": {
                "wysiwyg": true
              }
            },

            "sources": {
              "type": "array",
              "format": "table",
              "title": "Sources",
              "uniqueItems": true,
              "description": "Anything from books/articles to webpages.",
              "items": {
                "type": "object",
                "title": "Source",
                "properties": {
                  "fullBibliograficInfo": {
                   "type": "string"
                  },
                  "DOI": {
                   "type": "string"
                  }
                }
              },
              "options": {
                "disable_array_delete_last_row": true
              }
            },

            "keywords": {
              "type": "array",
              "format": "table",
              "title": "Keywords to search by",
              "description": "Type in the keywords by which users will be able to search for this reaction. Example: decarboxylation, hydrogentaion, oxidation, ...",
              "uniqueItems": true,
              "items": {
                "type": "string",
                "title": "keyword"
              },
              "options": {
                "disable_array_delete_last_row": true
              }
            },

            "functionalGroups": {
              "type": "array",
              "format": "table",
              "title": "Functional groups to search by",
              "options": {
                "disable_array_delete_last_row": true
              },
              "description": "Choose the functional group present in the initial reagent and then choose to which it transforms as a result of the reaction you are describing.",
              "items": {
                "type": "object",
                "title": "funcGroup",
                "properties": {
                  "from": {
                    "type": "string",
                    "enum": [
                      "- Hydrocarbons -",
                      "Alkyl",
                      "Alkenyl",
                      "Alkynyl",
                      "Phenyl",
                      " ",
                      "- With halogen -",
                      "Halo",
                      "Fluoro",
                      "Chloro",
                      "Bromo",
                      "Iodo",
                      " ",
                      "- With oxygen -",
                      "Hydroxyl",
                      "Carbonyl",
                      "Aldehyde",
                      "Haloformyl",
                      "Carbonate ester",
                      "Carboxylate",
                      "Carboxyl",
                      "Ester",
                      "Methoxy",
                      "Hydroperoxy",
                      "Peroxy",
                      "Ether",
                      "Hemiacetal",
                      "Hemiketal",
                      "Acetal",
                      "Ketal",
                      "Orthoester",
                      "Methylenedioxy",
                      "Orthocarbonate ester",
                      " ",
                      "- With nitrogen -",
                      "Carboxamide",
                      "Primary amine",
                      "Secondary amine",
                      "Tertiary amine",
                      "4Â° ammonium ion",
                      "Primary ketimine",
                      "Secondary ketimine",
                      "Primary aldimine",
                      "Secondary aldimine",
                      "Imide",
                      "Azide",
                      "Azo (Diimide)",
                      "Cyanate",
                      "Isocyanate",
                      "Nitrate",
                      "Nitrile",
                      "Isonitrile",
                      "Nitrosooxy",
                      "Nitro",
                      "Nitroso",
                      "Oxime",
                      "Pyridyl",
                      " ",
                      "- With sulfur -",
                      "Sulfhydryl",
                      "Sulfide",
                      "Disulfide",
                      "Sulfinyl",
                      "Sulfonyl",
                      "Sulfino",
                      "Sulfo",
                      "Thiocyanate",
                      "Isothiocyanate",
                      "Carbonothioyl",
                      "Carbonothioyl",
                      " ",
                      "- With phosphorous -",
                      "Phosphino",
                      "Phosphono",
                      "Phosphate",
                      "Phosphate",
                      " ",
                      "- With boron -",
                      "Borono",
                      "Boronate",
                      "Borino",
                      "Borinate"
                    ]
                  },
                  "to": {
                    "type": "string",
                    "enum": [
                      "- Hydrocarbons -",
                      "Alkyl",
                      "Alkenyl",
                      "Alkynyl",
                      "Phenyl",
                      " ",
                      "- With halogen -",
                      "Halo",
                      "Fluoro",
                      "Chloro",
                      "Bromo",
                      "Iodo",
                      " ",
                      "- With oxygen -",
                      "Hydroxyl",
                      "Carbonyl",
                      "Aldehyde",
                      "Haloformyl",
                      "Carbonate ester",
                      "Carboxylate",
                      "Carboxyl",
                      "Ester",
                      "Methoxy",
                      "Hydroperoxy",
                      "Peroxy",
                      "Ether",
                      "Hemiacetal",
                      "Hemiketal",
                      "Acetal",
                      "Ketal",
                      "Orthoester",
                      "Methylenedioxy",
                      "Orthocarbonate ester",
                      " ",
                      "- With nitrogen -",
                      "Carboxamide",
                      "Primary amine",
                      "Secondary amine",
                      "Tertiary amine",
                      "4Â° ammonium ion",
                      "Primary ketimine",
                      "Secondary ketimine",
                      "Primary aldimine",
                      "Secondary aldimine",
                      "Imide",
                      "Azide",
                      "Azo (Diimide)",
                      "Cyanate",
                      "Isocyanate",
                      "Nitrate",
                      "Nitrile",
                      "Isonitrile",
                      "Nitrosooxy",
                      "Nitro",
                      "Nitroso",
                      "Oxime",
                      "Pyridyl",
                      " ",
                      "- With sulfur -",
                      "Sulfhydryl",
                      "Sulfide",
                      "Disulfide",
                      "Sulfinyl",
                      "Sulfonyl",
                      "Sulfino",
                      "Sulfo",
                      "Thiocyanate",
                      "Isothiocyanate",
                      "Carbonothioyl",
                      "Carbonothioyl",
                      " ",
                      "- With phosphorous -",
                      "Phosphino",
                      "Phosphono",
                      "Phosphate",
                      "Phosphate",
                      " ",
                      "- With boron -",
                      "Borono",
                      "Boronate",
                      "Borino",
                      "Borinate"
                    ]
                  }
                }
              }
            }


          }
        },
        theme: 'bootstrap3',
        disable_collapse: 'true',
        disable_edit_json: 'true',
        disable_properties: 'true',
        disable_array_reorder: 'true'
    });

    document.getElementById('submit').addEventListener('click', function() {
      console.log(editor.getValue());
      var display = document.getElementById('output');
      var finaljson = editor.getValue(); // I need this!
      console.log("** * * ** * * *");
      console.log(finaljson);
      var password = document.getElementById('password').value;
      var statusLabel = document.getElementById('uploadStatus');
      // statusLabel.innerText = password;
      display.value = JSON.stringify(finaljson);

      if (password == "osresearch17") {

        $.ajax({
          type: 'POST',
          url: 'https://reactsearchdb.herokuapp.com/api/savedata',
          data: finaljson,
          success: function(data) { alert("data: " + data); },
          crossDomain: true,
          dataType: 'application/json'
        });

        // $.post("https://reactsearchdb.herokuapp.com/api/savedata", finaljson, function(){
        //   console.log('Success? I guess?');
        // });
        statusLabel.innerText = "Upload successful! Feel free to reload the page and work on the next reaction, if you prefer."
      } else {
        statusLabel.innerText = "Sorry, you\'ve typed in an incorrect password. Upload unsuccessful."
      }
    });

    var user_input = document.getElementById('exampleInputEmail1').value;


    function searchByCompoundName() {
      console.log("button pressed");
      var user_input = document.getElementById('exampleInputEmail1').value;
      console.log(user_input);

      var urlToParseForCID = "https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/"+user_input+"/JSON";
      console.log(urlToParseForCID);

      var finalCID;

      var getJSON = function(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open("get", url, true);
        xhr.responseType = "json";
        xhr.onload = function() {
          var status = xhr.status;
          if (status == 200) {
            callback(null, xhr.response);
          } else {
            callback(status);
          }
        };
        xhr.send();
    };

    getJSON(urlToParseForCID,
      function(err, data) {
        if (err != null) {
          finalCID = "Sorry, something went wrong! Probably, PubChem doesn't have a record on ";
          var pcidOutput = document.getElementById('PCID');
          pcidOutput.innerText = finalCID + user_input + " yet.";
          var noImage = "http://vignette3.wikia.nocookie.net/plants-vs-zombies-roleplay/images/6/60/Question_Mark.png/revision/latest?cb=20140425200212";
          document.getElementById('compoundImage').src = noImage;
        } else {
          console.log(data.PC_Compounds[0].id.id.cid);
          finalCID = data.PC_Compounds[0].id.id.cid;
          var pcidOutput = document.getElementById('PCID');
          pcidOutput.innerText = "Result for "+user_input+": "+finalCID;

          var imageFromPubChem = 'https://pubchem.ncbi.nlm.nih.gov/image/imagefly.cgi?cid='+finalCID+'&width=250&height=250';
          document.getElementById('compoundImage').src = imageFromPubChem;

        }
      });
    }

    // Getting the PCID and image by the enter key
    document.getElementById('exampleInputEmail1').addEventListener('keypress', function(e){
      var key = e.which || e.keyCode;
      if (key === 13) {
        e.preventDefault();
        console.log('hello world');
        searchByCompoundName();
      }
      return;
    });


    // Getting the PCID and image by the button press

    document.getElementById('getPCID').addEventListener('click', function() {
      searchByCompoundName();
    });

   </script>

 </body>
</html>

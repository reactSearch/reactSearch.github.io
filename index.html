<!DOCTYPE html>
   <html lang="en">
     <head>
       <title>reactSearch DB GUI</title>
       <meta name="viewport" content="width=device-width, initial-scale=1">
       <link href="bs/css/bootstrap.min.css" rel="stylesheet">
       <link href="bs/css/bootstrap-theme.min.css" rel="stylesheet">
       <script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
       <script type="text/javascript" src="bs/js/bootstrap.min.js"></script>
       <script type="text/javascript" src='js/jsoneditor.js'></script>
 </head>
 <body>
   <div class='container'>
       <div class='row'>
           <div class='span12 col-md-12 columns twelve large-12'>

               <h2>reactSearch Database GUI</h2>
               <p>Below is the editor generated from the JSON Schema with the help from <a href="https://github.com/jdorn/json-editor">json-editor</a> by <a href="https://github.com/jdorn">@jdorn</a>.</p>

               <br>
               <form>
                 <div class="form-group">
                   <label for="exampleInputEmail1">Get PubChem ID for any compound</label>
                   <input type="text" class="form-control" id="exampleInputEmail1" placeholder="Compound name in IUPAC, rational or SMILES nomenclature">
                 </div>
                 <button type="button" class="btn btn-default" id="getPCID">Get PubChem ID</button>
                 <br><br>
                 <div class="row">
                   <div class="col-md-3">
                   <label id="PCID">Result will be displayed here</label>
                 </div>
                 <div class="col-md-11">
                   <img src="http://vignette3.wikia.nocookie.net/plants-vs-zombies-roleplay/images/6/60/Question_Mark.png/revision/latest?cb=20140425200212" alt="Compound image by CID" width="250px" height="250px" id="compoundImage">
                 </div>
                 </div>
                </form>
               <br>

               <div id='editor'></div>
               <button id="submit" class="btn btn-success" type="submit">Add reaction</button>
               <br><br><br>
               <p>Resulting JSON. <b>TODO: automatic pasting into the database</b></p>
               <textarea id='output' style='width: 100%; height: 300px; font-family: monospace;' class='form-control'></textarea>
               <br><br>
           </div>
       </div>
   </div>

   <!-- Initializing the JSON form script -->
   <script>
    var editor = new JSONEditor(document.getElementById('editor'), {
      schema: {
          "title": "Add new reaction to the DB",
          "type": "object",
          "properties": {

            "reagents": {
              "type": "array",
              "format": "table",
              "title": "Initial reagents",
              "description": "Insert the PubChem IDs of the initial reagents (one at a time)",
              "uniqueItems": true,
              "items": {
                "type": "integer",
                "title": "reagent's PubChem ID"
              },
              "default": [
                0
              ],
              "options": {
                "disable_array_delete_last_row": true
              }
            },

            "products": {
              "type": "array",
              "format": "table",
              "title": "Resulting products",
              "description": "Insert the PubChem IDs of the final products (one at a time); this is used for the reaction searching and identifying!",
              "uniqueItems": true,
              "items": {
                "type": "integer",
                "title": "product's PubChem ID"
              },
              "default": [
                0
              ],
              "options": {
                "disable_array_delete_last_row": true
              }
            },

            "reactionImageLink": {
              "type": "string",
              "description": "Reaction overview image link (chemical equation image), preferably in PNG. EXAMPLE: https://raw.github.com/mawansui/reactions/id0.png"
            },

            "conditions": {
              "type": "string",
              "description": "Conditions at which the reaction takes place. EXAMPLE: 20 deg C, 101.3 kPa"
            },

            "catalysts": {
              "type": "string",
              "description": "What catalyses the reaction?"
            },

            "procedure": {
              "type": "string",
              "format": "textarea",
              "description": "TODO: Add a markdown editor"
            }
          }
        },
        theme: 'bootstrap3',
        disable_collapse: 'true',
        disable_edit_json: 'true',
        disable_properties: 'true',
        disable_array_reorder: 'true'
    });

    document.getElementById('submit').addEventListener('click', function() {
      console.log(editor.getValue());
      var display = document.getElementById('output');
      var finaljson = editor.getValue();
      display.value = JSON.stringify(finaljson);
    });

    // Getting the PCID

    document.getElementById('getPCID').addEventListener('click', function() {
      console.log("button pressed");
      var user_input = document.getElementById('exampleInputEmail1').value;
      console.log(user_input);

      var urlToParseForCID = "https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/"+user_input+"/JSON";
      console.log(urlToParseForCID);

      var finalCID;

      var getJSON = function(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open("get", url, true);
        xhr.responseType = "json";
        xhr.onload = function() {
          var status = xhr.status;
          if (status == 200) {
            callback(null, xhr.response);
          } else {
            callback(status);
          }
        };
        xhr.send();
    };

    getJSON(urlToParseForCID,
      function(err, data) {
        if (err != null) {
          finalCID = "Sorry, something went wrong! Probably, PubChem doesn't have a record on this compound yet."
          var pcidOutput = document.getElementById('PCID');
          pcidOutput.innerText = finalCID;
          var noImage = "http://vignette3.wikia.nocookie.net/plants-vs-zombies-roleplay/images/6/60/Question_Mark.png/revision/latest?cb=20140425200212";
          document.getElementById('compoundImage').src = noImage;
        } else {
          console.log(data.PC_Compounds[0].id.id.cid);
          finalCID = data.PC_Compounds[0].id.id.cid;
          var pcidOutput = document.getElementById('PCID');
          pcidOutput.innerText = "Result for "+user_input+": "+finalCID;

          var imageFromPubChem = 'https://pubchem.ncbi.nlm.nih.gov/image/imagefly.cgi?cid='+finalCID+'&width=250&height=250';
          document.getElementById('compoundImage').src = imageFromPubChem;

        }
      });
});

   </script>

 </body>
</html>
